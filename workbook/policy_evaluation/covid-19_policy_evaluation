{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import pandas\n",
    "from datetime import datetime\n",
    "\n",
    "from sklearn.metrics import mean_squared_error\n",
    "from sklearn.datasets import make_friedman1\n",
    "from sklearn.ensemble import GradientBoostingRegressor\n",
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.pipeline import Pipeline\n",
    "from sklearn.impute import SimpleImputer\n",
    "from sklearn.preprocessing import StandardScaler, OneHotEncoder\n",
    "\n",
    "from pandasql import sqldf\n",
    "pysqldf = lambda q: sqldf(q, globals())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "# state to two-letter abbreviation mapping\n",
    "\n",
    "us_state_abbrev = {\n",
    "    'Alabama': 'AL',\n",
    "    'Alaska': 'AK',\n",
    "    'American Samoa': 'AS',\n",
    "    'Arizona': 'AZ',\n",
    "    'Arkansas': 'AR',\n",
    "    'California': 'CA',\n",
    "    'Colorado': 'CO',\n",
    "    'Connecticut': 'CT',\n",
    "    'Delaware': 'DE',\n",
    "    'District of Columbia': 'DC',\n",
    "    'Florida': 'FL',\n",
    "    'Georgia': 'GA',\n",
    "    'Guam': 'GU',\n",
    "    'Hawaii': 'HI',\n",
    "    'Idaho': 'ID',\n",
    "    'Illinois': 'IL',\n",
    "    'Indiana': 'IN',\n",
    "    'Iowa': 'IA',\n",
    "    'Kansas': 'KS',\n",
    "    'Kentucky': 'KY',\n",
    "    'Louisiana': 'LA',\n",
    "    'Maine': 'ME',\n",
    "    'Maryland': 'MD',\n",
    "    'Massachusetts': 'MA',\n",
    "    'Michigan': 'MI',\n",
    "    'Minnesota': 'MN',\n",
    "    'Mississippi': 'MS',\n",
    "    'Missouri': 'MO',\n",
    "    'Montana': 'MT',\n",
    "    'Nebraska': 'NE',\n",
    "    'Nevada': 'NV',\n",
    "    'New Hampshire': 'NH',\n",
    "    'New Jersey': 'NJ',\n",
    "    'New Mexico': 'NM',\n",
    "    'New York': 'NY',\n",
    "    'North Carolina': 'NC',\n",
    "    'North Dakota': 'ND',\n",
    "    'Northern Mariana Islands':'MP',\n",
    "    'Ohio': 'OH',\n",
    "    'Oklahoma': 'OK',\n",
    "    'Oregon': 'OR',\n",
    "    'Pennsylvania': 'PA',\n",
    "    'Puerto Rico': 'PR',\n",
    "    'Rhode Island': 'RI',\n",
    "    'South Carolina': 'SC',\n",
    "    'South Dakota': 'SD',\n",
    "    'Tennessee': 'TN',\n",
    "    'Texas': 'TX',\n",
    "    'Utah': 'UT',\n",
    "    'Vermont': 'VT',\n",
    "    'Virgin Islands': 'VI',\n",
    "    'Virginia': 'VA',\n",
    "    'Washington': 'WA',\n",
    "    'West Virginia': 'WV',\n",
    "    'Wisconsin': 'WI',\n",
    "    'Wyoming': 'WY',\n",
    "}\n",
    "us_state_abbrev_lower = { k: us_state_abbrev[k].lower() for k in us_state_abbrev.keys() }"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "dict_values(['al', 'ak', 'as', 'az', 'ar', 'ca', 'co', 'ct', 'de', 'dc', 'fl', 'ga', 'gu', 'hi', 'id', 'il', 'in', 'ia', 'ks', 'ky', 'la', 'me', 'md', 'ma', 'mi', 'mn', 'ms', 'mo', 'mt', 'ne', 'nv', 'nh', 'nj', 'nm', 'ny', 'nc', 'nd', 'mp', 'oh', 'ok', 'or', 'pa', 'pr', 'ri', 'sc', 'sd', 'tn', 'tx', 'ut', 'vt', 'vi', 'va', 'wa', 'wv', 'wi', 'wy'])\n"
     ]
    }
   ],
   "source": [
    "print(us_state_abbrev_lower.values())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>state</th>\n",
       "      <th>smoothed_pct_cli_weighted</th>\n",
       "      <th>smoothed_pct_ili_weighted</th>\n",
       "      <th>smoothed_pct_self_fever_weighted</th>\n",
       "      <th>smoothed_pct_self_cough_weighted</th>\n",
       "      <th>smoothed_pct_self_shortness_of_breath_weighted</th>\n",
       "      <th>smoothed_pct_self_difficulty_breathing_weighted</th>\n",
       "      <th>smoothed_pct_self_tiredness_or_exhaustion_weighted</th>\n",
       "      <th>smoothed_pct_self_nasal_congestion_weighted</th>\n",
       "      <th>smoothed_pct_self_runny_nose_weighted</th>\n",
       "      <th>smoothed_pct_self_muscle_joint_aches_weighted</th>\n",
       "      <th>smoothed_pct_self_sore_throat_weighted</th>\n",
       "      <th>smoothed_pct_self_persistent_pain_pressure_in_chest_weighted</th>\n",
       "      <th>smoothed_pct_self_nausea_vomiting_weighted</th>\n",
       "      <th>smoothed_pct_self_diarrhea_weighted</th>\n",
       "      <th>smoothed_pct_self_multiple_symptoms_weighted</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2020-04-12</td>\n",
       "      <td>ak</td>\n",
       "      <td>0.924492</td>\n",
       "      <td>1.033970</td>\n",
       "      <td>1.223670</td>\n",
       "      <td>15.621587</td>\n",
       "      <td>4.648244</td>\n",
       "      <td>2.221548</td>\n",
       "      <td>15.080866</td>\n",
       "      <td>16.142131</td>\n",
       "      <td>17.960842</td>\n",
       "      <td>12.334458</td>\n",
       "      <td>8.093897</td>\n",
       "      <td>2.980421</td>\n",
       "      <td>3.184342</td>\n",
       "      <td>6.925321</td>\n",
       "      <td>2.007392</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2020-04-13</td>\n",
       "      <td>ak</td>\n",
       "      <td>0.714637</td>\n",
       "      <td>0.837073</td>\n",
       "      <td>1.082856</td>\n",
       "      <td>15.716196</td>\n",
       "      <td>4.509300</td>\n",
       "      <td>2.343243</td>\n",
       "      <td>15.444852</td>\n",
       "      <td>15.945381</td>\n",
       "      <td>17.852757</td>\n",
       "      <td>12.282205</td>\n",
       "      <td>8.165403</td>\n",
       "      <td>2.882388</td>\n",
       "      <td>3.512986</td>\n",
       "      <td>7.078623</td>\n",
       "      <td>2.048637</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2020-04-14</td>\n",
       "      <td>ak</td>\n",
       "      <td>0.636186</td>\n",
       "      <td>0.746453</td>\n",
       "      <td>1.042392</td>\n",
       "      <td>15.850805</td>\n",
       "      <td>4.636723</td>\n",
       "      <td>2.546868</td>\n",
       "      <td>15.347976</td>\n",
       "      <td>15.046316</td>\n",
       "      <td>17.411818</td>\n",
       "      <td>12.411797</td>\n",
       "      <td>8.227200</td>\n",
       "      <td>2.931977</td>\n",
       "      <td>3.415793</td>\n",
       "      <td>7.665086</td>\n",
       "      <td>1.898561</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2020-04-15</td>\n",
       "      <td>ak</td>\n",
       "      <td>0.614031</td>\n",
       "      <td>0.647247</td>\n",
       "      <td>1.013692</td>\n",
       "      <td>15.618680</td>\n",
       "      <td>4.376966</td>\n",
       "      <td>2.458152</td>\n",
       "      <td>14.882340</td>\n",
       "      <td>14.578623</td>\n",
       "      <td>16.854770</td>\n",
       "      <td>12.136618</td>\n",
       "      <td>7.935197</td>\n",
       "      <td>2.744155</td>\n",
       "      <td>3.238339</td>\n",
       "      <td>7.546989</td>\n",
       "      <td>1.484081</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2020-04-16</td>\n",
       "      <td>ak</td>\n",
       "      <td>0.586744</td>\n",
       "      <td>0.734023</td>\n",
       "      <td>0.945736</td>\n",
       "      <td>15.303189</td>\n",
       "      <td>4.036254</td>\n",
       "      <td>2.200012</td>\n",
       "      <td>14.903203</td>\n",
       "      <td>14.086725</td>\n",
       "      <td>16.717885</td>\n",
       "      <td>12.257689</td>\n",
       "      <td>7.489968</td>\n",
       "      <td>2.546724</td>\n",
       "      <td>2.952347</td>\n",
       "      <td>7.149550</td>\n",
       "      <td>1.577806</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8165</th>\n",
       "      <td>2020-09-12</td>\n",
       "      <td>wy</td>\n",
       "      <td>0.560018</td>\n",
       "      <td>0.560018</td>\n",
       "      <td>0.741239</td>\n",
       "      <td>11.398363</td>\n",
       "      <td>4.629123</td>\n",
       "      <td>3.793869</td>\n",
       "      <td>14.862366</td>\n",
       "      <td>11.918800</td>\n",
       "      <td>12.598999</td>\n",
       "      <td>13.851975</td>\n",
       "      <td>6.192486</td>\n",
       "      <td>1.607000</td>\n",
       "      <td>2.354441</td>\n",
       "      <td>6.089271</td>\n",
       "      <td>1.168108</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8166</th>\n",
       "      <td>2020-09-13</td>\n",
       "      <td>wy</td>\n",
       "      <td>0.525296</td>\n",
       "      <td>0.525296</td>\n",
       "      <td>0.697688</td>\n",
       "      <td>11.568170</td>\n",
       "      <td>4.907196</td>\n",
       "      <td>3.872609</td>\n",
       "      <td>14.602297</td>\n",
       "      <td>11.092391</td>\n",
       "      <td>12.676422</td>\n",
       "      <td>13.245338</td>\n",
       "      <td>6.117486</td>\n",
       "      <td>1.679287</td>\n",
       "      <td>2.598346</td>\n",
       "      <td>6.003052</td>\n",
       "      <td>1.158585</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8167</th>\n",
       "      <td>2020-09-14</td>\n",
       "      <td>wy</td>\n",
       "      <td>0.881329</td>\n",
       "      <td>0.881329</td>\n",
       "      <td>1.049404</td>\n",
       "      <td>11.864266</td>\n",
       "      <td>5.269843</td>\n",
       "      <td>4.063718</td>\n",
       "      <td>14.791969</td>\n",
       "      <td>12.882670</td>\n",
       "      <td>12.695917</td>\n",
       "      <td>13.566410</td>\n",
       "      <td>6.380437</td>\n",
       "      <td>1.614517</td>\n",
       "      <td>2.796098</td>\n",
       "      <td>6.195610</td>\n",
       "      <td>1.454078</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8168</th>\n",
       "      <td>2020-09-15</td>\n",
       "      <td>wy</td>\n",
       "      <td>0.709444</td>\n",
       "      <td>0.709444</td>\n",
       "      <td>0.876834</td>\n",
       "      <td>10.680328</td>\n",
       "      <td>4.848462</td>\n",
       "      <td>3.472864</td>\n",
       "      <td>14.655529</td>\n",
       "      <td>13.612076</td>\n",
       "      <td>13.239250</td>\n",
       "      <td>13.129453</td>\n",
       "      <td>6.874728</td>\n",
       "      <td>1.439733</td>\n",
       "      <td>2.762325</td>\n",
       "      <td>6.081717</td>\n",
       "      <td>1.446053</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8169</th>\n",
       "      <td>2020-09-16</td>\n",
       "      <td>wy</td>\n",
       "      <td>0.584827</td>\n",
       "      <td>0.584827</td>\n",
       "      <td>0.749627</td>\n",
       "      <td>10.949299</td>\n",
       "      <td>4.928209</td>\n",
       "      <td>3.616717</td>\n",
       "      <td>15.141265</td>\n",
       "      <td>12.831026</td>\n",
       "      <td>12.751116</td>\n",
       "      <td>13.678764</td>\n",
       "      <td>6.544311</td>\n",
       "      <td>1.102051</td>\n",
       "      <td>2.646172</td>\n",
       "      <td>5.860519</td>\n",
       "      <td>1.481846</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>8170 rows × 17 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "            date state  smoothed_pct_cli_weighted  smoothed_pct_ili_weighted  \\\n",
       "0     2020-04-12    ak                   0.924492                   1.033970   \n",
       "1     2020-04-13    ak                   0.714637                   0.837073   \n",
       "2     2020-04-14    ak                   0.636186                   0.746453   \n",
       "3     2020-04-15    ak                   0.614031                   0.647247   \n",
       "4     2020-04-16    ak                   0.586744                   0.734023   \n",
       "...          ...   ...                        ...                        ...   \n",
       "8165  2020-09-12    wy                   0.560018                   0.560018   \n",
       "8166  2020-09-13    wy                   0.525296                   0.525296   \n",
       "8167  2020-09-14    wy                   0.881329                   0.881329   \n",
       "8168  2020-09-15    wy                   0.709444                   0.709444   \n",
       "8169  2020-09-16    wy                   0.584827                   0.584827   \n",
       "\n",
       "      smoothed_pct_self_fever_weighted  smoothed_pct_self_cough_weighted  \\\n",
       "0                             1.223670                         15.621587   \n",
       "1                             1.082856                         15.716196   \n",
       "2                             1.042392                         15.850805   \n",
       "3                             1.013692                         15.618680   \n",
       "4                             0.945736                         15.303189   \n",
       "...                                ...                               ...   \n",
       "8165                          0.741239                         11.398363   \n",
       "8166                          0.697688                         11.568170   \n",
       "8167                          1.049404                         11.864266   \n",
       "8168                          0.876834                         10.680328   \n",
       "8169                          0.749627                         10.949299   \n",
       "\n",
       "      smoothed_pct_self_shortness_of_breath_weighted  \\\n",
       "0                                           4.648244   \n",
       "1                                           4.509300   \n",
       "2                                           4.636723   \n",
       "3                                           4.376966   \n",
       "4                                           4.036254   \n",
       "...                                              ...   \n",
       "8165                                        4.629123   \n",
       "8166                                        4.907196   \n",
       "8167                                        5.269843   \n",
       "8168                                        4.848462   \n",
       "8169                                        4.928209   \n",
       "\n",
       "      smoothed_pct_self_difficulty_breathing_weighted  \\\n",
       "0                                            2.221548   \n",
       "1                                            2.343243   \n",
       "2                                            2.546868   \n",
       "3                                            2.458152   \n",
       "4                                            2.200012   \n",
       "...                                               ...   \n",
       "8165                                         3.793869   \n",
       "8166                                         3.872609   \n",
       "8167                                         4.063718   \n",
       "8168                                         3.472864   \n",
       "8169                                         3.616717   \n",
       "\n",
       "      smoothed_pct_self_tiredness_or_exhaustion_weighted  \\\n",
       "0                                             15.080866    \n",
       "1                                             15.444852    \n",
       "2                                             15.347976    \n",
       "3                                             14.882340    \n",
       "4                                             14.903203    \n",
       "...                                                 ...    \n",
       "8165                                          14.862366    \n",
       "8166                                          14.602297    \n",
       "8167                                          14.791969    \n",
       "8168                                          14.655529    \n",
       "8169                                          15.141265    \n",
       "\n",
       "      smoothed_pct_self_nasal_congestion_weighted  \\\n",
       "0                                       16.142131   \n",
       "1                                       15.945381   \n",
       "2                                       15.046316   \n",
       "3                                       14.578623   \n",
       "4                                       14.086725   \n",
       "...                                           ...   \n",
       "8165                                    11.918800   \n",
       "8166                                    11.092391   \n",
       "8167                                    12.882670   \n",
       "8168                                    13.612076   \n",
       "8169                                    12.831026   \n",
       "\n",
       "      smoothed_pct_self_runny_nose_weighted  \\\n",
       "0                                 17.960842   \n",
       "1                                 17.852757   \n",
       "2                                 17.411818   \n",
       "3                                 16.854770   \n",
       "4                                 16.717885   \n",
       "...                                     ...   \n",
       "8165                              12.598999   \n",
       "8166                              12.676422   \n",
       "8167                              12.695917   \n",
       "8168                              13.239250   \n",
       "8169                              12.751116   \n",
       "\n",
       "      smoothed_pct_self_muscle_joint_aches_weighted  \\\n",
       "0                                         12.334458   \n",
       "1                                         12.282205   \n",
       "2                                         12.411797   \n",
       "3                                         12.136618   \n",
       "4                                         12.257689   \n",
       "...                                             ...   \n",
       "8165                                      13.851975   \n",
       "8166                                      13.245338   \n",
       "8167                                      13.566410   \n",
       "8168                                      13.129453   \n",
       "8169                                      13.678764   \n",
       "\n",
       "      smoothed_pct_self_sore_throat_weighted  \\\n",
       "0                                   8.093897   \n",
       "1                                   8.165403   \n",
       "2                                   8.227200   \n",
       "3                                   7.935197   \n",
       "4                                   7.489968   \n",
       "...                                      ...   \n",
       "8165                                6.192486   \n",
       "8166                                6.117486   \n",
       "8167                                6.380437   \n",
       "8168                                6.874728   \n",
       "8169                                6.544311   \n",
       "\n",
       "      smoothed_pct_self_persistent_pain_pressure_in_chest_weighted  \\\n",
       "0                                              2.980421              \n",
       "1                                              2.882388              \n",
       "2                                              2.931977              \n",
       "3                                              2.744155              \n",
       "4                                              2.546724              \n",
       "...                                                 ...              \n",
       "8165                                           1.607000              \n",
       "8166                                           1.679287              \n",
       "8167                                           1.614517              \n",
       "8168                                           1.439733              \n",
       "8169                                           1.102051              \n",
       "\n",
       "      smoothed_pct_self_nausea_vomiting_weighted  \\\n",
       "0                                       3.184342   \n",
       "1                                       3.512986   \n",
       "2                                       3.415793   \n",
       "3                                       3.238339   \n",
       "4                                       2.952347   \n",
       "...                                          ...   \n",
       "8165                                    2.354441   \n",
       "8166                                    2.598346   \n",
       "8167                                    2.796098   \n",
       "8168                                    2.762325   \n",
       "8169                                    2.646172   \n",
       "\n",
       "      smoothed_pct_self_diarrhea_weighted  \\\n",
       "0                                6.925321   \n",
       "1                                7.078623   \n",
       "2                                7.665086   \n",
       "3                                7.546989   \n",
       "4                                7.149550   \n",
       "...                                   ...   \n",
       "8165                             6.089271   \n",
       "8166                             6.003052   \n",
       "8167                             6.195610   \n",
       "8168                             6.081717   \n",
       "8169                             5.860519   \n",
       "\n",
       "      smoothed_pct_self_multiple_symptoms_weighted  \n",
       "0                                         2.007392  \n",
       "1                                         2.048637  \n",
       "2                                         1.898561  \n",
       "3                                         1.484081  \n",
       "4                                         1.577806  \n",
       "...                                            ...  \n",
       "8165                                      1.168108  \n",
       "8166                                      1.158585  \n",
       "8167                                      1.454078  \n",
       "8168                                      1.446053  \n",
       "8169                                      1.481846  \n",
       "\n",
       "[8170 rows x 17 columns]"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# read CMU data\n",
    "\n",
    "cmu_columns = (0, 1, 2, 3, 4, 54, 55, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 81, 93)\n",
    "cmu_column_names = (\n",
    "    # date and demographics\n",
    "    'date',\n",
    "    'state',\n",
    "    'gender',\n",
    "    'age_bucket',\n",
    "    'summed_n',\n",
    "    # symptoms\n",
    "    'smoothed_pct_cli_weighted',\n",
    "    'smoothed_pct_ili_weighted',\n",
    "    'smoothed_pct_self_fever_weighted',\n",
    "    'smoothed_pct_self_cough_weighted',\n",
    "    'smoothed_pct_self_shortness_of_breath_weighted',\n",
    "    'smoothed_pct_self_difficulty_breathing_weighted',\n",
    "    'smoothed_pct_self_tiredness_or_exhaustion_weighted',\n",
    "    'smoothed_pct_self_nasal_congestion_weighted',\n",
    "    'smoothed_pct_self_runny_nose_weighted',\n",
    "    'smoothed_pct_self_muscle_joint_aches_weighted',\n",
    "    'smoothed_pct_self_sore_throat_weighted',\n",
    "    'smoothed_pct_self_persistent_pain_pressure_in_chest_weighted',\n",
    "    'smoothed_pct_self_nausea_vomiting_weighted',\n",
    "    'smoothed_pct_self_diarrhea_weighted',\n",
    "    'smoothed_pct_self_multiple_symptoms_weighted',   \n",
    ")\n",
    "cmu_column_formats = (\n",
    "    'U10', 'U2','U10','U10', 'f',\n",
    "    'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f', 'f',   \n",
    ")\n",
    "\n",
    "cmu_data = np.loadtxt(\n",
    "    fname=\"/Users/qiongwu/git/272_covid19_project/dataset/cmuData.csv\", \n",
    "    delimiter=\",\", \n",
    "    skiprows=1,\n",
    "    usecols=cmu_columns,\n",
    "    dtype={\n",
    "        'names': cmu_column_names,\n",
    "        'formats': cmu_column_formats,\n",
    "    }\n",
    ")\n",
    "\n",
    "cmu_data = pandas.DataFrame(cmu_data, columns=cmu_column_names)\n",
    "# aggregate by state, date\n",
    "cmu_data = pysqldf(\"\"\"\n",
    "select\n",
    "    date,\n",
    "    state,\n",
    "    sum(summed_n * smoothed_pct_cli_weighted) / sum(summed_n) smoothed_pct_cli_weighted,\n",
    "    sum(summed_n * smoothed_pct_ili_weighted) / sum(summed_n) smoothed_pct_ili_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_fever_weighted) / sum(summed_n) smoothed_pct_self_fever_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_cough_weighted) / sum(summed_n) smoothed_pct_self_cough_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_shortness_of_breath_weighted) / sum(summed_n) smoothed_pct_self_shortness_of_breath_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_difficulty_breathing_weighted) / sum(summed_n) smoothed_pct_self_difficulty_breathing_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_tiredness_or_exhaustion_weighted) / sum(summed_n) smoothed_pct_self_tiredness_or_exhaustion_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_nasal_congestion_weighted) / sum(summed_n) smoothed_pct_self_nasal_congestion_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_runny_nose_weighted) / sum(summed_n) smoothed_pct_self_runny_nose_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_muscle_joint_aches_weighted) / sum(summed_n) smoothed_pct_self_muscle_joint_aches_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_sore_throat_weighted) / sum(summed_n) smoothed_pct_self_sore_throat_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_persistent_pain_pressure_in_chest_weighted) / sum(summed_n) smoothed_pct_self_persistent_pain_pressure_in_chest_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_nausea_vomiting_weighted) / sum(summed_n) smoothed_pct_self_nausea_vomiting_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_diarrhea_weighted) / sum(summed_n) smoothed_pct_self_diarrhea_weighted,\n",
    "    sum(summed_n * smoothed_pct_self_multiple_symptoms_weighted) / sum(summed_n) smoothed_pct_self_multiple_symptoms_weighted    \n",
    "from\n",
    "    cmu_data\n",
    "group by\n",
    "    state,\n",
    "    date\n",
    "\"\"\")\n",
    "cmu_data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>state_id</th>\n",
       "      <th>policy_type</th>\n",
       "      <th>start_date</th>\n",
       "      <th>stop_date</th>\n",
       "      <th>start_stop</th>\n",
       "      <th>start_stop</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>ak</td>\n",
       "      <td>Food and Drink</td>\n",
       "      <td>2020-03-18</td>\n",
       "      <td>2020-04-24</td>\n",
       "      <td>start</td>\n",
       "      <td>stop</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>ak</td>\n",
       "      <td>Mandate Face Mask Use By All Individuals In Pu...</td>\n",
       "      <td>2020-04-24</td>\n",
       "      <td>None</td>\n",
       "      <td>start</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>ak</td>\n",
       "      <td>Mandate Face Mask Use By All Individuals In Pu...</td>\n",
       "      <td>2020-04-24</td>\n",
       "      <td>None</td>\n",
       "      <td>start</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>ak</td>\n",
       "      <td>Non-Essential Businesses</td>\n",
       "      <td>2020-03-28</td>\n",
       "      <td>2020-04-24</td>\n",
       "      <td>start</td>\n",
       "      <td>stop</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>ak</td>\n",
       "      <td>Shelter in Place</td>\n",
       "      <td>2020-03-28</td>\n",
       "      <td>2020-04-24</td>\n",
       "      <td>start</td>\n",
       "      <td>stop</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>222</th>\n",
       "      <td>wv</td>\n",
       "      <td>Non-Essential Businesses</td>\n",
       "      <td>2020-03-24</td>\n",
       "      <td>2020-05-04</td>\n",
       "      <td>start</td>\n",
       "      <td>stop</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>223</th>\n",
       "      <td>wv</td>\n",
       "      <td>Shelter in Place</td>\n",
       "      <td>2020-03-24</td>\n",
       "      <td>2020-05-04</td>\n",
       "      <td>start</td>\n",
       "      <td>stop</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>224</th>\n",
       "      <td>wy</td>\n",
       "      <td>Food and Drink</td>\n",
       "      <td>2020-03-19</td>\n",
       "      <td>2020-05-15</td>\n",
       "      <td>start</td>\n",
       "      <td>stop</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>225</th>\n",
       "      <td>wy</td>\n",
       "      <td>Mandate Face Mask Use By All Individuals In Pu...</td>\n",
       "      <td>2020-05-01</td>\n",
       "      <td>None</td>\n",
       "      <td>start</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>226</th>\n",
       "      <td>wy</td>\n",
       "      <td>Non-Essential Businesses</td>\n",
       "      <td>2020-03-19</td>\n",
       "      <td>2020-05-01</td>\n",
       "      <td>start</td>\n",
       "      <td>stop</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>227 rows × 6 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "    state_id                                        policy_type  start_date  \\\n",
       "0         ak                                     Food and Drink  2020-03-18   \n",
       "1         ak  Mandate Face Mask Use By All Individuals In Pu...  2020-04-24   \n",
       "2         ak  Mandate Face Mask Use By All Individuals In Pu...  2020-04-24   \n",
       "3         ak                           Non-Essential Businesses  2020-03-28   \n",
       "4         ak                                   Shelter in Place  2020-03-28   \n",
       "..       ...                                                ...         ...   \n",
       "222       wv                           Non-Essential Businesses  2020-03-24   \n",
       "223       wv                                   Shelter in Place  2020-03-24   \n",
       "224       wy                                     Food and Drink  2020-03-19   \n",
       "225       wy  Mandate Face Mask Use By All Individuals In Pu...  2020-05-01   \n",
       "226       wy                           Non-Essential Businesses  2020-03-19   \n",
       "\n",
       "      stop_date start_stop start_stop  \n",
       "0    2020-04-24      start       stop  \n",
       "1          None      start       None  \n",
       "2          None      start       None  \n",
       "3    2020-04-24      start       stop  \n",
       "4    2020-04-24      start       stop  \n",
       "..          ...        ...        ...  \n",
       "222  2020-05-04      start       stop  \n",
       "223  2020-05-04      start       stop  \n",
       "224  2020-05-15      start       stop  \n",
       "225        None      start       None  \n",
       "226  2020-05-01      start       stop  \n",
       "\n",
       "[227 rows x 6 columns]"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# read policy data\n",
    "\n",
    "policy_columns = (0, 3, 4, 5, 6)\n",
    "policy_column_names = (\n",
    "    'state_id',\n",
    "    'policy_level',\n",
    "    'date',\n",
    "    'policy_type',\n",
    "    'start_stop',\n",
    ")\n",
    "policy_column_formats = (\n",
    "    'U4',\n",
    "    'U20',\n",
    "    'U10',\n",
    "    'U100',\n",
    "    'U10',\n",
    ")\n",
    "\n",
    "raw_policy_data = np.genfromtxt(\n",
    "    fname=\"/Users/qiongwu/git/272_covid19_project/dataset/state_policy_updates_20201019_1216_compact.csv\", \n",
    "    delimiter=\",\", \n",
    "    skip_header=1,\n",
    "    usecols=policy_columns,\n",
    "    dtype={\n",
    "        'names': policy_column_names,\n",
    "        'formats': policy_column_formats,\n",
    "    },\n",
    "    converters={\n",
    "        0: lambda x: x.decode(\"utf-8\").lower(),\n",
    "        4: lambda x: datetime.strftime(datetime.strptime(x.decode(\"utf-8\"), \"%m/%d/%y\"), \"%Y-%m-%d\")\n",
    "    }\n",
    ")\n",
    "\n",
    "raw_policy_data = pandas.DataFrame(raw_policy_data, columns=policy_column_names)\n",
    "\n",
    "raw_policy_data = pysqldf(\"\"\"\n",
    "select\n",
    "    date,\n",
    "    state_id,\n",
    "    policy_type,\n",
    "    start_stop\n",
    "from\n",
    "    raw_policy_data\n",
    "where\n",
    "    policy_level = 'state' and\n",
    "    policy_type in (\n",
    "        'Shelter in Place',\n",
    "        'Food and Drink',\n",
    "        'Non-Essential Businesses',\n",
    "        'Mandate Face Mask Use By All Individuals In Public Spaces',\n",
    "        'Mandate Face Mask Use By All Individuals In Public Facing Businesses'\n",
    "    )\n",
    "order by\n",
    "    state_id,\n",
    "    policy_type,\n",
    "    date\n",
    "\"\"\")\n",
    "\n",
    "policy_start = pysqldf(\"select * from raw_policy_data where start_stop = 'start'\")\n",
    "policy_stop = pysqldf(\"select * from raw_policy_data where start_stop = 'stop'\")\n",
    "\n",
    "policy_data = pysqldf(\"\"\"\n",
    "select\n",
    "    a.state_id state_id,\n",
    "    a.policy_type policy_type,\n",
    "    a.date start_date,\n",
    "    b.date stop_date,\n",
    "    a.start_stop,\n",
    "    b.start_stop\n",
    "from\n",
    "    policy_start a\n",
    "left outer join\n",
    "    policy_stop b\n",
    "on\n",
    "    a.state_id = b.state_id and\n",
    "    a.policy_type = b.policy_type\n",
    "order by\n",
    "    a.state_id,\n",
    "    a.policy_type\n",
    "\"\"\")\n",
    "\n",
    "policy_data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>state</th>\n",
       "      <th>population2019</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>None</td>\n",
       "      <td>705749.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>ak</td>\n",
       "      <td>731545.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>al</td>\n",
       "      <td>4903185.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>ar</td>\n",
       "      <td>3017825.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>az</td>\n",
       "      <td>7278717.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>ca</td>\n",
       "      <td>39512223.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>co</td>\n",
       "      <td>5758736.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>ct</td>\n",
       "      <td>3565287.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>de</td>\n",
       "      <td>973764.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>fl</td>\n",
       "      <td>21477737.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>ga</td>\n",
       "      <td>10617423.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>hi</td>\n",
       "      <td>1415872.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>ia</td>\n",
       "      <td>3155070.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>id</td>\n",
       "      <td>1787065.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>il</td>\n",
       "      <td>12671821.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>in</td>\n",
       "      <td>6732219.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>ks</td>\n",
       "      <td>2913314.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>ky</td>\n",
       "      <td>4467673.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>la</td>\n",
       "      <td>4648794.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>ma</td>\n",
       "      <td>6949503.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>md</td>\n",
       "      <td>6045680.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>me</td>\n",
       "      <td>1344212.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>22</th>\n",
       "      <td>mi</td>\n",
       "      <td>9986857.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>23</th>\n",
       "      <td>mn</td>\n",
       "      <td>5639632.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>24</th>\n",
       "      <td>mo</td>\n",
       "      <td>6137428.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25</th>\n",
       "      <td>ms</td>\n",
       "      <td>2976149.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>26</th>\n",
       "      <td>mt</td>\n",
       "      <td>1068778.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>27</th>\n",
       "      <td>nc</td>\n",
       "      <td>10488084.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>28</th>\n",
       "      <td>nd</td>\n",
       "      <td>762062.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>29</th>\n",
       "      <td>ne</td>\n",
       "      <td>1934408.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>30</th>\n",
       "      <td>nh</td>\n",
       "      <td>1359711.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>31</th>\n",
       "      <td>nj</td>\n",
       "      <td>8882190.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>32</th>\n",
       "      <td>nm</td>\n",
       "      <td>2096829.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>33</th>\n",
       "      <td>nv</td>\n",
       "      <td>3080156.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>34</th>\n",
       "      <td>ny</td>\n",
       "      <td>19453561.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>35</th>\n",
       "      <td>oh</td>\n",
       "      <td>11689100.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>36</th>\n",
       "      <td>ok</td>\n",
       "      <td>3956971.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>37</th>\n",
       "      <td>or</td>\n",
       "      <td>4217737.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>38</th>\n",
       "      <td>pa</td>\n",
       "      <td>12801989.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>39</th>\n",
       "      <td>ri</td>\n",
       "      <td>1059361.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>40</th>\n",
       "      <td>sc</td>\n",
       "      <td>5148714.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>41</th>\n",
       "      <td>sd</td>\n",
       "      <td>884659.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>42</th>\n",
       "      <td>tn</td>\n",
       "      <td>6833174.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>43</th>\n",
       "      <td>tx</td>\n",
       "      <td>28995881.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>44</th>\n",
       "      <td>ut</td>\n",
       "      <td>3205958.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>45</th>\n",
       "      <td>va</td>\n",
       "      <td>8535519.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>46</th>\n",
       "      <td>vt</td>\n",
       "      <td>623989.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>47</th>\n",
       "      <td>wa</td>\n",
       "      <td>7614893.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>48</th>\n",
       "      <td>wi</td>\n",
       "      <td>5822434.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>49</th>\n",
       "      <td>wv</td>\n",
       "      <td>1792147.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>50</th>\n",
       "      <td>wy</td>\n",
       "      <td>578759.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   state  population2019\n",
       "0   None        705749.0\n",
       "1     ak        731545.0\n",
       "2     al       4903185.0\n",
       "3     ar       3017825.0\n",
       "4     az       7278717.0\n",
       "5     ca      39512223.0\n",
       "6     co       5758736.0\n",
       "7     ct       3565287.0\n",
       "8     de        973764.0\n",
       "9     fl      21477737.0\n",
       "10    ga      10617423.0\n",
       "11    hi       1415872.0\n",
       "12    ia       3155070.0\n",
       "13    id       1787065.0\n",
       "14    il      12671821.0\n",
       "15    in       6732219.0\n",
       "16    ks       2913314.0\n",
       "17    ky       4467673.0\n",
       "18    la       4648794.0\n",
       "19    ma       6949503.0\n",
       "20    md       6045680.0\n",
       "21    me       1344212.0\n",
       "22    mi       9986857.0\n",
       "23    mn       5639632.0\n",
       "24    mo       6137428.0\n",
       "25    ms       2976149.0\n",
       "26    mt       1068778.0\n",
       "27    nc      10488084.0\n",
       "28    nd        762062.0\n",
       "29    ne       1934408.0\n",
       "30    nh       1359711.0\n",
       "31    nj       8882190.0\n",
       "32    nm       2096829.0\n",
       "33    nv       3080156.0\n",
       "34    ny      19453561.0\n",
       "35    oh      11689100.0\n",
       "36    ok       3956971.0\n",
       "37    or       4217737.0\n",
       "38    pa      12801989.0\n",
       "39    ri       1059361.0\n",
       "40    sc       5148714.0\n",
       "41    sd        884659.0\n",
       "42    tn       6833174.0\n",
       "43    tx      28995881.0\n",
       "44    ut       3205958.0\n",
       "45    va       8535519.0\n",
       "46    vt        623989.0\n",
       "47    wa       7614893.0\n",
       "48    wi       5822434.0\n",
       "49    wv       1792147.0\n",
       "50    wy        578759.0"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# load 2019 population data\n",
    "\n",
    "population2019_column_names = (\n",
    "    'state',\n",
    "    'population2019'\n",
    ")\n",
    "population2019_column_formats = (\n",
    "    'U30',\n",
    "    'd'\n",
    ")\n",
    "population2019_data = np.genfromtxt(\n",
    "    fname=\"/Users/qiongwu/git/272_covid19_project/dataset/state_population_2019.csv\", \n",
    "    delimiter=\",\", \n",
    "    skip_header=0,\n",
    "    dtype={\n",
    "        'names': population2019_column_names,\n",
    "        'formats': population2019_column_formats,       \n",
    "    },\n",
    "    converters={\n",
    "        0: lambda x: us_state_abbrev_lower.get(x.decode(\"utf-8\"), None)\n",
    "    } \n",
    ")\n",
    "    \n",
    "population2019_data = pandas.DataFrame(population2019_data, columns=population2019_column_names)\n",
    "population2019_data = pysqldf(\"\"\"\n",
    "select\n",
    "    *\n",
    "from\n",
    "    population2019_data\n",
    "order by\n",
    "    state\n",
    "\"\"\")\n",
    "\n",
    "population2019_data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>state</th>\n",
       "      <th>confirmed</th>\n",
       "      <th>death</th>\n",
       "      <th>recovered</th>\n",
       "      <th>active</th>\n",
       "      <th>tested</th>\n",
       "      <th>hospitalized</th>\n",
       "      <th>mortality_rate</th>\n",
       "      <th>testing_rate</th>\n",
       "      <th>hospitalization_rate</th>\n",
       "      <th>confirmed_delta</th>\n",
       "      <th>tested_delta</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2020-04-14</td>\n",
       "      <td>ak</td>\n",
       "      <td>285.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>98.0</td>\n",
       "      <td>276.0</td>\n",
       "      <td>8348.0</td>\n",
       "      <td>32.0</td>\n",
       "      <td>3.157895</td>\n",
       "      <td>1396.572754</td>\n",
       "      <td>11.228070</td>\n",
       "      <td>8.0</td>\n",
       "      <td>518.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2020-04-15</td>\n",
       "      <td>ak</td>\n",
       "      <td>293.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>106.0</td>\n",
       "      <td>284.0</td>\n",
       "      <td>8664.0</td>\n",
       "      <td>34.0</td>\n",
       "      <td>3.071672</td>\n",
       "      <td>1449.437866</td>\n",
       "      <td>11.604095</td>\n",
       "      <td>8.0</td>\n",
       "      <td>316.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2020-04-16</td>\n",
       "      <td>ak</td>\n",
       "      <td>300.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>110.0</td>\n",
       "      <td>291.0</td>\n",
       "      <td>8735.0</td>\n",
       "      <td>35.0</td>\n",
       "      <td>3.000000</td>\n",
       "      <td>1461.315674</td>\n",
       "      <td>11.666667</td>\n",
       "      <td>7.0</td>\n",
       "      <td>71.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2020-04-17</td>\n",
       "      <td>ak</td>\n",
       "      <td>309.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>128.0</td>\n",
       "      <td>300.0</td>\n",
       "      <td>9450.0</td>\n",
       "      <td>36.0</td>\n",
       "      <td>2.912621</td>\n",
       "      <td>1580.931152</td>\n",
       "      <td>11.650485</td>\n",
       "      <td>9.0</td>\n",
       "      <td>715.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2020-04-18</td>\n",
       "      <td>ak</td>\n",
       "      <td>314.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>147.0</td>\n",
       "      <td>305.0</td>\n",
       "      <td>9655.0</td>\n",
       "      <td>39.0</td>\n",
       "      <td>2.866242</td>\n",
       "      <td>1615.226440</td>\n",
       "      <td>12.420382</td>\n",
       "      <td>5.0</td>\n",
       "      <td>205.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11407</th>\n",
       "      <td>2020-11-22</td>\n",
       "      <td>wy</td>\n",
       "      <td>28169.0</td>\n",
       "      <td>176.0</td>\n",
       "      <td>16807.0</td>\n",
       "      <td>11186.0</td>\n",
       "      <td>159957.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.624800</td>\n",
       "      <td>27637.929688</td>\n",
       "      <td>NaN</td>\n",
       "      <td>759.0</td>\n",
       "      <td>759.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11408</th>\n",
       "      <td>2020-11-23</td>\n",
       "      <td>wy</td>\n",
       "      <td>29431.0</td>\n",
       "      <td>202.0</td>\n",
       "      <td>17452.0</td>\n",
       "      <td>11777.0</td>\n",
       "      <td>161219.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.686351</td>\n",
       "      <td>27855.982422</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1262.0</td>\n",
       "      <td>1262.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11409</th>\n",
       "      <td>2020-11-24</td>\n",
       "      <td>wy</td>\n",
       "      <td>29959.0</td>\n",
       "      <td>202.0</td>\n",
       "      <td>17896.0</td>\n",
       "      <td>11861.0</td>\n",
       "      <td>161747.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.674255</td>\n",
       "      <td>27947.210938</td>\n",
       "      <td>NaN</td>\n",
       "      <td>528.0</td>\n",
       "      <td>528.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11410</th>\n",
       "      <td>2020-11-25</td>\n",
       "      <td>wy</td>\n",
       "      <td>30761.0</td>\n",
       "      <td>215.0</td>\n",
       "      <td>20113.0</td>\n",
       "      <td>10433.0</td>\n",
       "      <td>385040.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.698937</td>\n",
       "      <td>66528.554688</td>\n",
       "      <td>NaN</td>\n",
       "      <td>802.0</td>\n",
       "      <td>223293.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11411</th>\n",
       "      <td>2020-11-27</td>\n",
       "      <td>wy</td>\n",
       "      <td>31773.0</td>\n",
       "      <td>215.0</td>\n",
       "      <td>21700.0</td>\n",
       "      <td>9858.0</td>\n",
       "      <td>393512.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.676675</td>\n",
       "      <td>67992.375000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1012.0</td>\n",
       "      <td>8472.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>11412 rows × 13 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "             date state  confirmed  death  recovered   active    tested  \\\n",
       "0      2020-04-14    ak      285.0    9.0       98.0    276.0    8348.0   \n",
       "1      2020-04-15    ak      293.0    9.0      106.0    284.0    8664.0   \n",
       "2      2020-04-16    ak      300.0    9.0      110.0    291.0    8735.0   \n",
       "3      2020-04-17    ak      309.0    9.0      128.0    300.0    9450.0   \n",
       "4      2020-04-18    ak      314.0    9.0      147.0    305.0    9655.0   \n",
       "...           ...   ...        ...    ...        ...      ...       ...   \n",
       "11407  2020-11-22    wy    28169.0  176.0    16807.0  11186.0  159957.0   \n",
       "11408  2020-11-23    wy    29431.0  202.0    17452.0  11777.0  161219.0   \n",
       "11409  2020-11-24    wy    29959.0  202.0    17896.0  11861.0  161747.0   \n",
       "11410  2020-11-25    wy    30761.0  215.0    20113.0  10433.0  385040.0   \n",
       "11411  2020-11-27    wy    31773.0  215.0    21700.0   9858.0  393512.0   \n",
       "\n",
       "       hospitalized  mortality_rate  testing_rate  hospitalization_rate  \\\n",
       "0              32.0        3.157895   1396.572754             11.228070   \n",
       "1              34.0        3.071672   1449.437866             11.604095   \n",
       "2              35.0        3.000000   1461.315674             11.666667   \n",
       "3              36.0        2.912621   1580.931152             11.650485   \n",
       "4              39.0        2.866242   1615.226440             12.420382   \n",
       "...             ...             ...           ...                   ...   \n",
       "11407           NaN        0.624800  27637.929688                   NaN   \n",
       "11408           NaN        0.686351  27855.982422                   NaN   \n",
       "11409           NaN        0.674255  27947.210938                   NaN   \n",
       "11410           NaN        0.698937  66528.554688                   NaN   \n",
       "11411           NaN        0.676675  67992.375000                   NaN   \n",
       "\n",
       "       confirmed_delta  tested_delta  \n",
       "0                  8.0         518.0  \n",
       "1                  8.0         316.0  \n",
       "2                  7.0          71.0  \n",
       "3                  9.0         715.0  \n",
       "4                  5.0         205.0  \n",
       "...                ...           ...  \n",
       "11407            759.0         759.0  \n",
       "11408           1262.0        1262.0  \n",
       "11409            528.0         528.0  \n",
       "11410            802.0      223293.0  \n",
       "11411           1012.0        8472.0  \n",
       "\n",
       "[11412 rows x 13 columns]"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# load CSSE data\n",
    "\n",
    "# = shell script to merge per-day CSV files\n",
    "\n",
    "# #!/bin/bash\n",
    "\n",
    "# echo -n Date,\n",
    "# cat `ls | head -n 1` | head -n 1\n",
    "# for filename in `ls`; do\n",
    "#     if [[ \"$filename\" =~ ([0-9][0-9])\\-([0-9][0-9])\\-([0-9][0-9][0-9][0-9]) ]]; then\n",
    "#         date=${BASH_REMATCH[3]}-${BASH_REMATCH[1]}-${BASH_REMATCH[2]}\n",
    "#         tail -n +2 $filename | sed -e \"s/^/$date,/\"\n",
    "#     fi\n",
    "# done\n",
    "\n",
    "\n",
    "csse_columns = (0, 1, 6, 7, 8, 9, 12, 13, 14, 17, 18)\n",
    "csse_column_names = (\n",
    "    'date',\n",
    "    'state',\n",
    "    'confirmed',\n",
    "    'death',\n",
    "    'recovered',\n",
    "    'active',\n",
    "    'tested',\n",
    "    'hospitalized',\n",
    "    'mortality_rate',\n",
    "    'testing_rate',\n",
    "    'hospitalization_rate',\n",
    ")\n",
    "csse_column_formats = (\n",
    "    'U10',\n",
    "    'U30',\n",
    "    'f',\n",
    "    'f',\n",
    "    'f',\n",
    "    'f',\n",
    "    'f',\n",
    "    'f',\n",
    "    'f',\n",
    "    'f',\n",
    "    'f',  \n",
    ")\n",
    "\n",
    "csse_raw_data = np.genfromtxt(\n",
    "    fname=\"/Users/qiongwu/git/272_covid19_project/dataset/merged.csv\", \n",
    "    delimiter=\",\", \n",
    "    skip_header=1,\n",
    "    usecols=csse_columns,\n",
    "    dtype={\n",
    "        'names': csse_column_names,\n",
    "        'formats': csse_column_formats,       \n",
    "    },\n",
    "    converters={\n",
    "        1: lambda x: us_state_abbrev_lower.get(x.decode(\"utf-8\"), None)\n",
    "    } \n",
    ")\n",
    "\n",
    "csse_raw_data = pandas.DataFrame(csse_raw_data, columns=csse_column_names)\n",
    "csse_raw_data = pysqldf(\"\"\"\n",
    "select\n",
    "    *\n",
    "from\n",
    "    csse_raw_data\n",
    "where\n",
    "    state != 'None'\n",
    "order by\n",
    "    state,\n",
    "    date\n",
    "\"\"\")\n",
    "\n",
    "csse_data = pysqldf(\"\"\"\n",
    "select\n",
    "    d2.*,\n",
    "    d2.confirmed - d1.confirmed confirmed_delta,\n",
    "    d2.tested - d1.tested tested_delta\n",
    "from\n",
    "    csse_raw_data d1\n",
    "inner join\n",
    "    csse_raw_data d2\n",
    "on\n",
    "    julianday(d2.date) - julianday(d1.date) = 1 and \n",
    "    d1.state = d2.state\n",
    "where\n",
    "    confirmed_delta > 0 and\n",
    "    tested_delta > 0\n",
    "\"\"\")\n",
    "\n",
    "\n",
    "csse_data\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>state</th>\n",
       "      <th>confirmed</th>\n",
       "      <th>death</th>\n",
       "      <th>recovered</th>\n",
       "      <th>active</th>\n",
       "      <th>tested</th>\n",
       "      <th>hospitalized</th>\n",
       "      <th>mortality_rate</th>\n",
       "      <th>testing_rate</th>\n",
       "      <th>...</th>\n",
       "      <th>smoothed_pct_self_nausea_vomiting_weighted</th>\n",
       "      <th>smoothed_pct_self_diarrhea_weighted</th>\n",
       "      <th>smoothed_pct_self_multiple_symptoms_weighted</th>\n",
       "      <th>population2019</th>\n",
       "      <th>shelter_in_place_policy</th>\n",
       "      <th>food_and_drink_policy</th>\n",
       "      <th>non_essential_businesses_policy</th>\n",
       "      <th>face_mask_public_policy</th>\n",
       "      <th>face_mask_business_policy</th>\n",
       "      <th>has_cmu_data</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2020-04-14</td>\n",
       "      <td>ak</td>\n",
       "      <td>285.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>98.0</td>\n",
       "      <td>276.0</td>\n",
       "      <td>8348.0</td>\n",
       "      <td>32.0</td>\n",
       "      <td>3.157895</td>\n",
       "      <td>1396.572754</td>\n",
       "      <td>...</td>\n",
       "      <td>3.415793</td>\n",
       "      <td>7.665086</td>\n",
       "      <td>1.898561</td>\n",
       "      <td>731545.0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2020-04-15</td>\n",
       "      <td>ak</td>\n",
       "      <td>293.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>106.0</td>\n",
       "      <td>284.0</td>\n",
       "      <td>8664.0</td>\n",
       "      <td>34.0</td>\n",
       "      <td>3.071672</td>\n",
       "      <td>1449.437866</td>\n",
       "      <td>...</td>\n",
       "      <td>3.238339</td>\n",
       "      <td>7.546989</td>\n",
       "      <td>1.484081</td>\n",
       "      <td>731545.0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2020-04-16</td>\n",
       "      <td>ak</td>\n",
       "      <td>300.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>110.0</td>\n",
       "      <td>291.0</td>\n",
       "      <td>8735.0</td>\n",
       "      <td>35.0</td>\n",
       "      <td>3.000000</td>\n",
       "      <td>1461.315674</td>\n",
       "      <td>...</td>\n",
       "      <td>2.952347</td>\n",
       "      <td>7.149550</td>\n",
       "      <td>1.577806</td>\n",
       "      <td>731545.0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2020-04-17</td>\n",
       "      <td>ak</td>\n",
       "      <td>309.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>128.0</td>\n",
       "      <td>300.0</td>\n",
       "      <td>9450.0</td>\n",
       "      <td>36.0</td>\n",
       "      <td>2.912621</td>\n",
       "      <td>1580.931152</td>\n",
       "      <td>...</td>\n",
       "      <td>2.956160</td>\n",
       "      <td>7.396441</td>\n",
       "      <td>1.516258</td>\n",
       "      <td>731545.0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2020-04-18</td>\n",
       "      <td>ak</td>\n",
       "      <td>314.0</td>\n",
       "      <td>9.0</td>\n",
       "      <td>147.0</td>\n",
       "      <td>305.0</td>\n",
       "      <td>9655.0</td>\n",
       "      <td>39.0</td>\n",
       "      <td>2.866242</td>\n",
       "      <td>1615.226440</td>\n",
       "      <td>...</td>\n",
       "      <td>2.916061</td>\n",
       "      <td>7.048577</td>\n",
       "      <td>1.266249</td>\n",
       "      <td>731545.0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11407</th>\n",
       "      <td>2020-11-22</td>\n",
       "      <td>wy</td>\n",
       "      <td>28169.0</td>\n",
       "      <td>176.0</td>\n",
       "      <td>16807.0</td>\n",
       "      <td>11186.0</td>\n",
       "      <td>159957.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.624800</td>\n",
       "      <td>27637.929688</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>578759.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11408</th>\n",
       "      <td>2020-11-23</td>\n",
       "      <td>wy</td>\n",
       "      <td>29431.0</td>\n",
       "      <td>202.0</td>\n",
       "      <td>17452.0</td>\n",
       "      <td>11777.0</td>\n",
       "      <td>161219.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.686351</td>\n",
       "      <td>27855.982422</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>578759.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11409</th>\n",
       "      <td>2020-11-24</td>\n",
       "      <td>wy</td>\n",
       "      <td>29959.0</td>\n",
       "      <td>202.0</td>\n",
       "      <td>17896.0</td>\n",
       "      <td>11861.0</td>\n",
       "      <td>161747.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.674255</td>\n",
       "      <td>27947.210938</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>578759.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11410</th>\n",
       "      <td>2020-11-25</td>\n",
       "      <td>wy</td>\n",
       "      <td>30761.0</td>\n",
       "      <td>215.0</td>\n",
       "      <td>20113.0</td>\n",
       "      <td>10433.0</td>\n",
       "      <td>385040.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.698937</td>\n",
       "      <td>66528.554688</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>578759.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11411</th>\n",
       "      <td>2020-11-27</td>\n",
       "      <td>wy</td>\n",
       "      <td>31773.0</td>\n",
       "      <td>215.0</td>\n",
       "      <td>21700.0</td>\n",
       "      <td>9858.0</td>\n",
       "      <td>393512.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.676675</td>\n",
       "      <td>67992.375000</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>578759.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>11412 rows × 37 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "             date state  confirmed  death  recovered   active    tested  \\\n",
       "0      2020-04-14    ak      285.0    9.0       98.0    276.0    8348.0   \n",
       "1      2020-04-15    ak      293.0    9.0      106.0    284.0    8664.0   \n",
       "2      2020-04-16    ak      300.0    9.0      110.0    291.0    8735.0   \n",
       "3      2020-04-17    ak      309.0    9.0      128.0    300.0    9450.0   \n",
       "4      2020-04-18    ak      314.0    9.0      147.0    305.0    9655.0   \n",
       "...           ...   ...        ...    ...        ...      ...       ...   \n",
       "11407  2020-11-22    wy    28169.0  176.0    16807.0  11186.0  159957.0   \n",
       "11408  2020-11-23    wy    29431.0  202.0    17452.0  11777.0  161219.0   \n",
       "11409  2020-11-24    wy    29959.0  202.0    17896.0  11861.0  161747.0   \n",
       "11410  2020-11-25    wy    30761.0  215.0    20113.0  10433.0  385040.0   \n",
       "11411  2020-11-27    wy    31773.0  215.0    21700.0   9858.0  393512.0   \n",
       "\n",
       "       hospitalized  mortality_rate  testing_rate  ...  \\\n",
       "0              32.0        3.157895   1396.572754  ...   \n",
       "1              34.0        3.071672   1449.437866  ...   \n",
       "2              35.0        3.000000   1461.315674  ...   \n",
       "3              36.0        2.912621   1580.931152  ...   \n",
       "4              39.0        2.866242   1615.226440  ...   \n",
       "...             ...             ...           ...  ...   \n",
       "11407           NaN        0.624800  27637.929688  ...   \n",
       "11408           NaN        0.686351  27855.982422  ...   \n",
       "11409           NaN        0.674255  27947.210938  ...   \n",
       "11410           NaN        0.698937  66528.554688  ...   \n",
       "11411           NaN        0.676675  67992.375000  ...   \n",
       "\n",
       "       smoothed_pct_self_nausea_vomiting_weighted  \\\n",
       "0                                        3.415793   \n",
       "1                                        3.238339   \n",
       "2                                        2.952347   \n",
       "3                                        2.956160   \n",
       "4                                        2.916061   \n",
       "...                                           ...   \n",
       "11407                                         NaN   \n",
       "11408                                         NaN   \n",
       "11409                                         NaN   \n",
       "11410                                         NaN   \n",
       "11411                                         NaN   \n",
       "\n",
       "       smoothed_pct_self_diarrhea_weighted  \\\n",
       "0                                 7.665086   \n",
       "1                                 7.546989   \n",
       "2                                 7.149550   \n",
       "3                                 7.396441   \n",
       "4                                 7.048577   \n",
       "...                                    ...   \n",
       "11407                                  NaN   \n",
       "11408                                  NaN   \n",
       "11409                                  NaN   \n",
       "11410                                  NaN   \n",
       "11411                                  NaN   \n",
       "\n",
       "       smoothed_pct_self_multiple_symptoms_weighted population2019  \\\n",
       "0                                          1.898561       731545.0   \n",
       "1                                          1.484081       731545.0   \n",
       "2                                          1.577806       731545.0   \n",
       "3                                          1.516258       731545.0   \n",
       "4                                          1.266249       731545.0   \n",
       "...                                             ...            ...   \n",
       "11407                                           NaN       578759.0   \n",
       "11408                                           NaN       578759.0   \n",
       "11409                                           NaN       578759.0   \n",
       "11410                                           NaN       578759.0   \n",
       "11411                                           NaN       578759.0   \n",
       "\n",
       "      shelter_in_place_policy  food_and_drink_policy  \\\n",
       "0                           1                      1   \n",
       "1                           1                      1   \n",
       "2                           1                      1   \n",
       "3                           1                      1   \n",
       "4                           1                      1   \n",
       "...                       ...                    ...   \n",
       "11407                       0                      0   \n",
       "11408                       0                      0   \n",
       "11409                       0                      0   \n",
       "11410                       0                      0   \n",
       "11411                       0                      0   \n",
       "\n",
       "       non_essential_businesses_policy  face_mask_public_policy  \\\n",
       "0                                    1                        0   \n",
       "1                                    1                        0   \n",
       "2                                    1                        0   \n",
       "3                                    1                        0   \n",
       "4                                    1                        0   \n",
       "...                                ...                      ...   \n",
       "11407                                0                        0   \n",
       "11408                                0                        0   \n",
       "11409                                0                        0   \n",
       "11410                                0                        0   \n",
       "11411                                0                        0   \n",
       "\n",
       "       face_mask_business_policy  has_cmu_data  \n",
       "0                              0             1  \n",
       "1                              0             1  \n",
       "2                              0             1  \n",
       "3                              0             1  \n",
       "4                              0             1  \n",
       "...                          ...           ...  \n",
       "11407                          1             0  \n",
       "11408                          1             0  \n",
       "11409                          1             0  \n",
       "11410                          1             0  \n",
       "11411                          1             0  \n",
       "\n",
       "[11412 rows x 37 columns]"
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# join all data together\n",
    "\n",
    "\n",
    "policy1_data = pysqldf(\"select * from policy_data where policy_type = 'Shelter in Place'\")\n",
    "policy2_data = pysqldf(\"select * from policy_data where policy_type = 'Food and Drink'\")\n",
    "policy3_data = pysqldf(\"select * from policy_data where policy_type = 'Non-Essential Businesses'\")\n",
    "policy4_data = pysqldf(\n",
    "    \"select * from policy_data where policy_type = 'Mandate Face Mask Use By All Individuals In Public Spaces'\")\n",
    "policy5_data = pysqldf(\n",
    "    \"select * from policy_data where policy_type = 'Mandate Face Mask Use By All Individuals In Public Facing Businesses'\")\n",
    "\n",
    "all_data_combined = pysqldf(\"\"\"\n",
    "select\n",
    "    csse_data.*,\n",
    "    cmu_data.*,\n",
    "    population2019_data.population2019,\n",
    "    case when policy1.policy_type is not null then 1 else 0 end shelter_in_place_policy,\n",
    "    case when policy2.policy_type is not null then 1 else 0 end food_and_drink_policy,\n",
    "    case when policy3.policy_type is not null then 1 else 0 end non_essential_businesses_policy,\n",
    "    case when policy4.policy_type is not null then 1 else 0 end face_mask_public_policy,\n",
    "    case when policy5.policy_type is not null then 1 else 0 end face_mask_business_policy,\n",
    "    case when cmu_data.state is not null then 1 else 0 end has_cmu_data\n",
    "from\n",
    "    csse_data\n",
    "left outer join\n",
    "    population2019_data\n",
    "on\n",
    "    csse_data.state = population2019_data.state\n",
    "left outer join\n",
    "    cmu_data\n",
    "on\n",
    "    csse_data.date = cmu_data.date and\n",
    "    csse_data.state = cmu_data.state\n",
    "left outer join\n",
    "    policy1_data policy1\n",
    "on\n",
    "    csse_data.state = policy1.state_id and\n",
    "    policy1.start_date <= csse_data.date and\n",
    "    (policy1.stop_date >= csse_data.date or policy1.stop_date is null)\n",
    "left outer join\n",
    "    policy2_data policy2\n",
    "on\n",
    "    csse_data.state = policy2.state_id and\n",
    "    policy2.start_date <= csse_data.date and\n",
    "    (policy2.stop_date >= csse_data.date or policy2.stop_date is null)\n",
    "left outer join\n",
    "    policy3_data policy3\n",
    "on\n",
    "    csse_data.state = policy3.state_id and\n",
    "    policy3.start_date <= csse_data.date and\n",
    "    (policy3.stop_date >= csse_data.date or policy3.stop_date is null)\n",
    "left outer join\n",
    "    policy4_data policy4\n",
    "on\n",
    "    csse_data.state = policy4.state_id and\n",
    "    policy4.start_date <= csse_data.date and\n",
    "    (policy4.stop_date >= csse_data.date or policy4.stop_date is null)\n",
    "left outer join\n",
    "    policy5_data policy5\n",
    "on\n",
    "    csse_data.state = policy5.state_id and\n",
    "    policy5.start_date <= csse_data.date and\n",
    "    (policy5.stop_date >= csse_data.date or policy5.stop_date is null)\n",
    "\"\"\")\n",
    "\n",
    "all_data_combined\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>future_confirmed_delta_per_capita</th>\n",
       "      <th>state</th>\n",
       "      <th>smoothed_pct_cli_weighted</th>\n",
       "      <th>smoothed_pct_ili_weighted</th>\n",
       "      <th>smoothed_pct_self_fever_weighted</th>\n",
       "      <th>smoothed_pct_self_cough_weighted</th>\n",
       "      <th>smoothed_pct_self_shortness_of_breath_weighted</th>\n",
       "      <th>smoothed_pct_self_difficulty_breathing_weighted</th>\n",
       "      <th>smoothed_pct_self_tiredness_or_exhaustion_weighted</th>\n",
       "      <th>...</th>\n",
       "      <th>smoothed_pct_self_diarrhea_weighted</th>\n",
       "      <th>smoothed_pct_self_multiple_symptoms_weighted</th>\n",
       "      <th>shelter_in_place_policy</th>\n",
       "      <th>food_and_drink_policy</th>\n",
       "      <th>non_essential_businesses_policy</th>\n",
       "      <th>face_mask_public_policy</th>\n",
       "      <th>face_mask_business_policy</th>\n",
       "      <th>active_per_capita</th>\n",
       "      <th>confirmed_per_capita</th>\n",
       "      <th>confirmed_delta_per_capita</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2020-04-13</td>\n",
       "      <td>0.000030</td>\n",
       "      <td>al</td>\n",
       "      <td>1.061175</td>\n",
       "      <td>1.095937</td>\n",
       "      <td>1.329804</td>\n",
       "      <td>18.806119</td>\n",
       "      <td>5.852417</td>\n",
       "      <td>2.763908</td>\n",
       "      <td>14.412259</td>\n",
       "      <td>...</td>\n",
       "      <td>7.148619</td>\n",
       "      <td>1.862451</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0.000741</td>\n",
       "      <td>0.000789</td>\n",
       "      <td>0.000041</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2020-04-13</td>\n",
       "      <td>0.000023</td>\n",
       "      <td>ar</td>\n",
       "      <td>1.107573</td>\n",
       "      <td>1.073379</td>\n",
       "      <td>1.287236</td>\n",
       "      <td>19.750751</td>\n",
       "      <td>5.952442</td>\n",
       "      <td>2.957267</td>\n",
       "      <td>16.249394</td>\n",
       "      <td>...</td>\n",
       "      <td>7.099813</td>\n",
       "      <td>1.748727</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0.000458</td>\n",
       "      <td>0.000467</td>\n",
       "      <td>0.000043</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2020-04-13</td>\n",
       "      <td>0.000026</td>\n",
       "      <td>az</td>\n",
       "      <td>1.065547</td>\n",
       "      <td>1.081123</td>\n",
       "      <td>1.354223</td>\n",
       "      <td>15.544654</td>\n",
       "      <td>5.663844</td>\n",
       "      <td>2.668707</td>\n",
       "      <td>15.266326</td>\n",
       "      <td>...</td>\n",
       "      <td>6.549384</td>\n",
       "      <td>1.574480</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0.000492</td>\n",
       "      <td>0.000509</td>\n",
       "      <td>0.000022</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2020-04-13</td>\n",
       "      <td>0.000036</td>\n",
       "      <td>ca</td>\n",
       "      <td>0.664891</td>\n",
       "      <td>0.663204</td>\n",
       "      <td>0.876870</td>\n",
       "      <td>13.425639</td>\n",
       "      <td>4.068206</td>\n",
       "      <td>2.041942</td>\n",
       "      <td>11.994709</td>\n",
       "      <td>...</td>\n",
       "      <td>5.509776</td>\n",
       "      <td>1.253120</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0.000588</td>\n",
       "      <td>0.000606</td>\n",
       "      <td>0.000029</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2020-04-13</td>\n",
       "      <td>0.000076</td>\n",
       "      <td>co</td>\n",
       "      <td>1.441438</td>\n",
       "      <td>1.459337</td>\n",
       "      <td>1.727728</td>\n",
       "      <td>16.251716</td>\n",
       "      <td>5.999360</td>\n",
       "      <td>3.197653</td>\n",
       "      <td>16.032279</td>\n",
       "      <td>...</td>\n",
       "      <td>6.904712</td>\n",
       "      <td>1.937172</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0.001282</td>\n",
       "      <td>0.001336</td>\n",
       "      <td>0.000067</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6394</th>\n",
       "      <td>2020-09-02</td>\n",
       "      <td>0.000242</td>\n",
       "      <td>wi</td>\n",
       "      <td>0.534142</td>\n",
       "      <td>0.600385</td>\n",
       "      <td>0.763836</td>\n",
       "      <td>8.487989</td>\n",
       "      <td>3.750558</td>\n",
       "      <td>2.387601</td>\n",
       "      <td>12.874050</td>\n",
       "      <td>...</td>\n",
       "      <td>4.974459</td>\n",
       "      <td>1.205205</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0.001262</td>\n",
       "      <td>0.013247</td>\n",
       "      <td>0.000094</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6395</th>\n",
       "      <td>2020-09-02</td>\n",
       "      <td>0.000121</td>\n",
       "      <td>wv</td>\n",
       "      <td>0.678395</td>\n",
       "      <td>0.691561</td>\n",
       "      <td>0.901347</td>\n",
       "      <td>9.613960</td>\n",
       "      <td>5.152058</td>\n",
       "      <td>3.073501</td>\n",
       "      <td>13.811087</td>\n",
       "      <td>...</td>\n",
       "      <td>5.845513</td>\n",
       "      <td>1.247386</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0.001205</td>\n",
       "      <td>0.005947</td>\n",
       "      <td>0.000081</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6396</th>\n",
       "      <td>2020-09-02</td>\n",
       "      <td>0.000218</td>\n",
       "      <td>wy</td>\n",
       "      <td>0.646955</td>\n",
       "      <td>0.764724</td>\n",
       "      <td>0.943722</td>\n",
       "      <td>9.336400</td>\n",
       "      <td>5.207477</td>\n",
       "      <td>3.416411</td>\n",
       "      <td>13.847044</td>\n",
       "      <td>...</td>\n",
       "      <td>6.992238</td>\n",
       "      <td>1.007030</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0.001073</td>\n",
       "      <td>0.006758</td>\n",
       "      <td>0.000064</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6397</th>\n",
       "      <td>2020-09-03</td>\n",
       "      <td>0.000260</td>\n",
       "      <td>ne</td>\n",
       "      <td>0.871715</td>\n",
       "      <td>0.859748</td>\n",
       "      <td>1.049642</td>\n",
       "      <td>10.189682</td>\n",
       "      <td>4.143652</td>\n",
       "      <td>2.520282</td>\n",
       "      <td>15.388921</td>\n",
       "      <td>...</td>\n",
       "      <td>6.160873</td>\n",
       "      <td>1.698909</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0.004445</td>\n",
       "      <td>0.018336</td>\n",
       "      <td>0.000245</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6398</th>\n",
       "      <td>2020-09-03</td>\n",
       "      <td>0.000072</td>\n",
       "      <td>pa</td>\n",
       "      <td>0.416572</td>\n",
       "      <td>0.463516</td>\n",
       "      <td>0.574475</td>\n",
       "      <td>7.705014</td>\n",
       "      <td>3.317164</td>\n",
       "      <td>2.044892</td>\n",
       "      <td>12.797058</td>\n",
       "      <td>...</td>\n",
       "      <td>4.966345</td>\n",
       "      <td>1.082110</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0.001801</td>\n",
       "      <td>0.011058</td>\n",
       "      <td>0.000081</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>6399 rows × 26 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "            date  future_confirmed_delta_per_capita state  \\\n",
       "0     2020-04-13                           0.000030    al   \n",
       "1     2020-04-13                           0.000023    ar   \n",
       "2     2020-04-13                           0.000026    az   \n",
       "3     2020-04-13                           0.000036    ca   \n",
       "4     2020-04-13                           0.000076    co   \n",
       "...          ...                                ...   ...   \n",
       "6394  2020-09-02                           0.000242    wi   \n",
       "6395  2020-09-02                           0.000121    wv   \n",
       "6396  2020-09-02                           0.000218    wy   \n",
       "6397  2020-09-03                           0.000260    ne   \n",
       "6398  2020-09-03                           0.000072    pa   \n",
       "\n",
       "      smoothed_pct_cli_weighted  smoothed_pct_ili_weighted  \\\n",
       "0                      1.061175                   1.095937   \n",
       "1                      1.107573                   1.073379   \n",
       "2                      1.065547                   1.081123   \n",
       "3                      0.664891                   0.663204   \n",
       "4                      1.441438                   1.459337   \n",
       "...                         ...                        ...   \n",
       "6394                   0.534142                   0.600385   \n",
       "6395                   0.678395                   0.691561   \n",
       "6396                   0.646955                   0.764724   \n",
       "6397                   0.871715                   0.859748   \n",
       "6398                   0.416572                   0.463516   \n",
       "\n",
       "      smoothed_pct_self_fever_weighted  smoothed_pct_self_cough_weighted  \\\n",
       "0                             1.329804                         18.806119   \n",
       "1                             1.287236                         19.750751   \n",
       "2                             1.354223                         15.544654   \n",
       "3                             0.876870                         13.425639   \n",
       "4                             1.727728                         16.251716   \n",
       "...                                ...                               ...   \n",
       "6394                          0.763836                          8.487989   \n",
       "6395                          0.901347                          9.613960   \n",
       "6396                          0.943722                          9.336400   \n",
       "6397                          1.049642                         10.189682   \n",
       "6398                          0.574475                          7.705014   \n",
       "\n",
       "      smoothed_pct_self_shortness_of_breath_weighted  \\\n",
       "0                                           5.852417   \n",
       "1                                           5.952442   \n",
       "2                                           5.663844   \n",
       "3                                           4.068206   \n",
       "4                                           5.999360   \n",
       "...                                              ...   \n",
       "6394                                        3.750558   \n",
       "6395                                        5.152058   \n",
       "6396                                        5.207477   \n",
       "6397                                        4.143652   \n",
       "6398                                        3.317164   \n",
       "\n",
       "      smoothed_pct_self_difficulty_breathing_weighted  \\\n",
       "0                                            2.763908   \n",
       "1                                            2.957267   \n",
       "2                                            2.668707   \n",
       "3                                            2.041942   \n",
       "4                                            3.197653   \n",
       "...                                               ...   \n",
       "6394                                         2.387601   \n",
       "6395                                         3.073501   \n",
       "6396                                         3.416411   \n",
       "6397                                         2.520282   \n",
       "6398                                         2.044892   \n",
       "\n",
       "      smoothed_pct_self_tiredness_or_exhaustion_weighted  ...  \\\n",
       "0                                             14.412259   ...   \n",
       "1                                             16.249394   ...   \n",
       "2                                             15.266326   ...   \n",
       "3                                             11.994709   ...   \n",
       "4                                             16.032279   ...   \n",
       "...                                                 ...   ...   \n",
       "6394                                          12.874050   ...   \n",
       "6395                                          13.811087   ...   \n",
       "6396                                          13.847044   ...   \n",
       "6397                                          15.388921   ...   \n",
       "6398                                          12.797058   ...   \n",
       "\n",
       "      smoothed_pct_self_diarrhea_weighted  \\\n",
       "0                                7.148619   \n",
       "1                                7.099813   \n",
       "2                                6.549384   \n",
       "3                                5.509776   \n",
       "4                                6.904712   \n",
       "...                                   ...   \n",
       "6394                             4.974459   \n",
       "6395                             5.845513   \n",
       "6396                             6.992238   \n",
       "6397                             6.160873   \n",
       "6398                             4.966345   \n",
       "\n",
       "      smoothed_pct_self_multiple_symptoms_weighted  shelter_in_place_policy  \\\n",
       "0                                         1.862451                        1   \n",
       "1                                         1.748727                        0   \n",
       "2                                         1.574480                        1   \n",
       "3                                         1.253120                        1   \n",
       "4                                         1.937172                        1   \n",
       "...                                            ...                      ...   \n",
       "6394                                      1.205205                        0   \n",
       "6395                                      1.247386                        0   \n",
       "6396                                      1.007030                        0   \n",
       "6397                                      1.698909                        0   \n",
       "6398                                      1.082110                        0   \n",
       "\n",
       "      food_and_drink_policy  non_essential_businesses_policy  \\\n",
       "0                         1                                1   \n",
       "1                         1                                1   \n",
       "2                         1                                1   \n",
       "3                         1                                1   \n",
       "4                         1                                1   \n",
       "...                     ...                              ...   \n",
       "6394                      0                                0   \n",
       "6395                      0                                0   \n",
       "6396                      0                                0   \n",
       "6397                      0                                0   \n",
       "6398                      0                                0   \n",
       "\n",
       "      face_mask_public_policy  face_mask_business_policy  active_per_capita  \\\n",
       "0                           0                          0           0.000741   \n",
       "1                           0                          0           0.000458   \n",
       "2                           0                          0           0.000492   \n",
       "3                           0                          0           0.000588   \n",
       "4                           0                          0           0.001282   \n",
       "...                       ...                        ...                ...   \n",
       "6394                        1                          1           0.001262   \n",
       "6395                        1                          1           0.001205   \n",
       "6396                        0                          1           0.001073   \n",
       "6397                        0                          1           0.004445   \n",
       "6398                        1                          1           0.001801   \n",
       "\n",
       "      confirmed_per_capita  confirmed_delta_per_capita  \n",
       "0                 0.000789                    0.000041  \n",
       "1                 0.000467                    0.000043  \n",
       "2                 0.000509                    0.000022  \n",
       "3                 0.000606                    0.000029  \n",
       "4                 0.001336                    0.000067  \n",
       "...                    ...                         ...  \n",
       "6394              0.013247                    0.000094  \n",
       "6395              0.005947                    0.000081  \n",
       "6396              0.006758                    0.000064  \n",
       "6397              0.018336                    0.000245  \n",
       "6398              0.011058                    0.000081  \n",
       "\n",
       "[6399 rows x 26 columns]"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# generate training and demo data\n",
    "# feature from day 1\n",
    "# use day 14 confirmed_delta_per_capita as label\n",
    "\n",
    "labeled_data = pysqldf(\"\"\"\n",
    "select\n",
    "    present.date,\n",
    "    future.confirmed_delta / present.population2019 future_confirmed_delta_per_capita,\n",
    "    present.state,\n",
    "    present.smoothed_pct_cli_weighted,\n",
    "    present.smoothed_pct_ili_weighted,\n",
    "    present.smoothed_pct_self_fever_weighted,\n",
    "    present.smoothed_pct_self_cough_weighted,\n",
    "    present.smoothed_pct_self_shortness_of_breath_weighted,\n",
    "    present.smoothed_pct_self_difficulty_breathing_weighted,\n",
    "    present.smoothed_pct_self_tiredness_or_exhaustion_weighted,\n",
    "    present.smoothed_pct_self_nasal_congestion_weighted,\n",
    "    present.smoothed_pct_self_runny_nose_weighted,\n",
    "    present.smoothed_pct_self_muscle_joint_aches_weighted,\n",
    "    present.smoothed_pct_self_sore_throat_weighted,\n",
    "    present.smoothed_pct_self_persistent_pain_pressure_in_chest_weighted,\n",
    "    present.smoothed_pct_self_nausea_vomiting_weighted,\n",
    "    present.smoothed_pct_self_diarrhea_weighted,\n",
    "    present.smoothed_pct_self_multiple_symptoms_weighted,\n",
    "    present.shelter_in_place_policy,\n",
    "    present.food_and_drink_policy,\n",
    "    present.non_essential_businesses_policy,\n",
    "    present.face_mask_public_policy,\n",
    "    present.face_mask_business_policy,\n",
    "    present.active / present.population2019 active_per_capita,\n",
    "    present.confirmed / present.population2019 confirmed_per_capita,\n",
    "    present.confirmed_delta / present.population2019 confirmed_delta_per_capita   \n",
    "from\n",
    "    all_data_combined present\n",
    "inner join\n",
    "    all_data_combined future\n",
    "on\n",
    "    julianday(future.date) - julianday(present.date) = 14 and\n",
    "    present.state = future.state\n",
    "where\n",
    "    future_confirmed_delta_per_capita is not null and\n",
    "    present.has_cmu_data\n",
    "order by\n",
    "    present.date,\n",
    "    present.state\n",
    "\"\"\")\n",
    "\n",
    "\n",
    "labeled_data\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [],
   "source": [
    "# split train and test by date\n",
    "\n",
    "dates = pysqldf(\"select distinct date from labeled_data order by date\").to_numpy()[:, 0]\n",
    "\n",
    "split_by_date = dates[round(np.size(dates) * .8)]\n",
    "\n",
    "train_data = pysqldf(\"select * from labeled_data where date < '{split_by_date}'\".format(split_by_date = split_by_date))\n",
    "test_data = pysqldf(\"select * from labeled_data where date >= '{split_by_date}'\".format(split_by_date = split_by_date))\n",
    "\n",
    "# test_data_y\n",
    "\n",
    "# # create a transformer for the categorical values\n",
    "# categorical_transformer = Pipeline(steps=[\n",
    "#     ('imputer', SimpleImputer(strategy='constant', fill_value='missing')),\n",
    "#     ('one_hot', OneHotEncoder())])\n",
    "\n",
    "# # create a transformed for the numerical values\n",
    "# numeric_transformer = Pipeline(steps=[\n",
    "#     ('imputer', SimpleImputer(strategy='median')),\n",
    "#     ('scaler', StandardScaler())])\n",
    "\n",
    "# preprocessor = ColumnTransformer(\n",
    "#     transformers=[\n",
    "#         ('unused', 'drop, [0, 1])\n",
    "#         ('num', numeric_transformer, numeric_features),\n",
    "#         ('cat', categorical_transformer, categorical_features)\n",
    "#     ])\n",
    "\n",
    "# init state feature encoder\n",
    "state_feature_encoder = OneHotEncoder()\n",
    "state_feature_encoder.fit(labeled_data.to_numpy()[:, [2]])\n",
    "\n",
    "def gen_xy(data):\n",
    "    data_np = data.to_numpy()\n",
    "    # remove date\n",
    "    data_np = np.delete(data_np, 0, 1)\n",
    "    # get label\n",
    "    y = data_np[:, 0]\n",
    "    # remove label\n",
    "    data_np = np.delete(data_np, 0, 1)\n",
    "    # encode state in one-hot\n",
    "    state_feature = data_np[:, [0]]\n",
    "    state_feature = state_feature_encoder.transform(state_feature).toarray()\n",
    "    # remove state feature\n",
    "    other_features = np.delete(data_np, 0, 1)\n",
    "    # concatenate state feature and other features\n",
    "    x = np.concatenate((state_feature, other_features), 1)\n",
    "    # return\n",
    "    return x, y\n",
    "\n",
    "# train model\n",
    "x_train, y_train = gen_xy(train_data)\n",
    "x_test, y_test = gen_xy(test_data)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "est = GradientBoostingRegressor(\n",
    "    n_estimators=100,\n",
    "    learning_rate=0.1,\n",
    "    max_depth=3, \n",
    "    random_state=0, \n",
    "    loss='ls'\n",
    ").fit(x_train, y_train)\n",
    "\n",
    "# eval model\n",
    "\n",
    "mean_squared_error(y_test, est.predict(x_test))\n",
    "\n",
    "\n",
    "importances = est.feature_importances_\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "ename": "NameError",
     "evalue": "name 'state' is not defined",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)",
      "\u001b[0;32m<ipython-input-12-e443ff87acaf>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m\u001b[0m\n\u001b[1;32m     17\u001b[0m \u001b[0morder\u001b[0m \u001b[0mby\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     18\u001b[0m     \u001b[0mdate\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 19\u001b[0;31m \"\"\".format(state = state))\n\u001b[0m\u001b[1;32m     20\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     21\u001b[0m \u001b[0;31m# accumlate to total confirmed\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
      "\u001b[0;31mNameError\u001b[0m: name 'state' is not defined"
     ]
    }
   ],
   "source": [
    "# plot trend chart\n",
    "\n",
    "chart_data = pysqldf(\"\"\"\n",
    "select\n",
    "    date,\n",
    "    predicted_confirmed_delta_per_capita,\n",
    "    future_confirmed_delta_per_capita actual_confirmed_delta_per_capita\n",
    "from\n",
    "    results\n",
    "where\n",
    "    state = '{state}' and\n",
    "    shelter_in_place_policy = 1 and\n",
    "    food_and_drink_policy = 1 and\n",
    "    non_essential_businesses_policy = 1 and\n",
    "    face_mask_public_policy = 1 and\n",
    "    face_mask_business_policy = 1\n",
    "order by\n",
    "    date\n",
    "\"\"\".format(state = state))\n",
    "\n",
    "# accumlate to total confirmed\n",
    "\n",
    "def accumulate_confirmed(initial_confirmed, population, confirmed_per_capital_series):\n",
    "    out = [initial_confirmed]\n",
    "    for i in range(0, len(confirmed_per_capital_series) - 1):\n",
    "        out.append(out[i] + population * confirmed_per_capital_series[i])\n",
    "    return out\n",
    "\n",
    "population = pysqldf(\n",
    "    \"select population2019 from population2019_data where state = '{state}'\".format(state = state)\n",
    ")['population2019'][0]\n",
    "\n",
    "initial_date = pysqldf(\"\"\"\n",
    "select min(date) from results where state = '{state}'\n",
    "\"\"\".format(state = state))['min(date)'][0]\n",
    "\n",
    "initial_confirmed = pysqldf(\"\"\"\n",
    "select confirmed from csse_data where state = '{state}' and date = '{date}'\n",
    "\"\"\".format(state = state, date = initial_date))['confirmed'][0]\n",
    "\n",
    "chart_data = pandas.DataFrame(\n",
    "    {\n",
    "        'predicted_confirmed': accumulate_confirmed(initial_confirmed, population, chart_data['predicted_confirmed_delta_per_capita'].to_numpy()),\n",
    "        'actual_confirmed': accumulate_confirmed(initial_confirmed, population, chart_data['actual_confirmed_delta_per_capita'].to_numpy()),\n",
    "    },\n",
    "    index = pandas.to_datetime(chart_data['date'])\n",
    ")\n",
    "\n",
    "chart_data.plot()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# generate CSV\n",
    "\n",
    "csv_data = None\n",
    "\n",
    "for p1 in (0, 1):\n",
    "    for p2 in (0, 1):\n",
    "        for p3 in (0, 1):\n",
    "            for p4 in (0, 1):\n",
    "                for p5 in (0, 1):\n",
    "                    csv_fragment = pysqldf(\"\"\"\n",
    "                    select\n",
    "                        date,\n",
    "                        state,\n",
    "                        shelter_in_place_policy,\n",
    "                        food_and_drink_policy,\n",
    "                        non_essential_businesses_policy,\n",
    "                        face_mask_public_policy,\n",
    "                        face_mask_business_policy,\n",
    "                        predicted_confirmed_delta_per_capita,\n",
    "                        future_confirmed_delta_per_capita actual_confirmed_delta_per_capita\n",
    "                    from\n",
    "                        results\n",
    "                    where\n",
    "                        state = '{state}' and\n",
    "                        shelter_in_place_policy = {p1} and\n",
    "                        food_and_drink_policy = {p2} and\n",
    "                        non_essential_businesses_policy = {p3} and\n",
    "                        face_mask_public_policy = {p4} and\n",
    "                        face_mask_business_policy = {p5}\n",
    "                    order by\n",
    "                        date\n",
    "                    \"\"\".format(state = state, p1 = p1, p2 = p2, p3 = p3, p4 = p4, p5 = p5))\n",
    "                    csv_fragment.insert(\n",
    "                        9,\n",
    "                        \"predicted_confirmed\",\n",
    "                        accumulate_confirmed(initial_confirmed, population, csv_fragment['predicted_confirmed_delta_per_capita'].to_numpy())\n",
    "                    )\n",
    "                    csv_fragment.insert(\n",
    "                        9,\n",
    "                        \"actual_confirmed\",\n",
    "                        accumulate_confirmed(initial_confirmed, population, csv_fragment['actual_confirmed_delta_per_capita'].to_numpy())\n",
    "                    )\n",
    "                    if csv_data is None:\n",
    "                        csv_data = csv_fragment\n",
    "                    else:\n",
    "                        csv_data = pandas.concat([csv_data, csv_fragment])\n",
    "                    \n",
    "csv_data.to_csv(\"ny.csv\")\n",
    "csv_data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import glob\n",
    "import pandas as pd\n",
    "os.chdir(\"/Users/qiongwu/git/272_covid19_project/predicted_confirmed_policy_exploded\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "extension = 'csv'\n",
    "all_filenames = [i for i in glob.glob('*.{}'.format(extension))]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "#combine all files in the list\n",
    "combined_csv = pd.concat([pd.read_csv(f) for f in all_filenames ])\n",
    "#export to csv\n",
    "combined_csv.to_csv( \"combined_csv.csv\", index=False, encoding='utf-8-sig')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
